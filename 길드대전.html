<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- 확대/축소를 막기 위한 meta viewport 설정 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>길드대전 배치 템플릿</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* 화면 전체 컨테이너 */
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f9f9f9;
      height: 100vh;
      overflow: hidden;
      user-select: none;
      top: 30px; /* 페이지 전체를 30px 아래로 내림 */
    }
    
    .fixed-container {
      width: 360px;
      height: 740px;
      position: relative;
      background-color: #f9f9f9;
      overflow: hidden;
      border: 1px solid #ccc;
    }
    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 30px;
      background: #ffffff;
      padding: 0 0px;
      box-shadow: 0 2px 5px rgba(255, 255, 255);
      position: absolute;
      top: 60px;
      left: 0;
      z-index: 1100;
      gap: 0;
    }
    
    .nav-title {
      font-size: 14px;
      font-weight: bold;
      color: #9c2121;
    }
    
    .nav-buttons {
      display: flex;
      align-items: center;
      gap: 1px;
    }
    
    .round-btn {
      width: 50px;
      height: 44px;
      background-color: #ffffff;
      border: none;
      border-radius: 0px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .round-btn:hover {
      background-color: #1abc9c;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .round-btn img {
      width: 100%;
      height: 70%;
      object-fit: cover;
      border-radius: 0;
    }
    
    .round-btn span {
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #000000;
      font-size: 8px;
      font-weight: bold;
      pointer-events: none;
    }
    
    /* 메인 영역 */
    main {
      position: absolute;
      top: 100px;
      bottom: 10px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    
    /* 내부 컨테이너 */
    .container {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      margin: 0;
      padding: 0;
      min-height: 0;
    }
    
    .map-container {
      position: relative;
      width: 360px;
      height: 360px;
      overflow: hidden;
    }
    
    #mapImage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* 드롭존 스타일 */
    .drop-zone {
      width: 35px;
      height: 35px;
      position: absolute;
      border: 1px dashed rgba(102, 102, 102, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      background-color: rgba(255, 255, 255, 0.8);
      transition: background-color 0.3s ease;
      border-radius: 6px;
    }
    
    .drop-zone:hover {
      background-color: rgba(255, 165, 0, 0.7);
    }
    
    /* 드래그 가능한 이미지 스타일 */
    .drop-zone img {
      cursor: move;
      touch-action: none; /* 터치 시 브라우저 기본 동작 방지 */
      -webkit-user-drag: element; /* iOS에서 드래그 지원 */
      user-select: none;
    }

    /* 고스트 이미지 스타일 */
    .ghost-image {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
      border-radius: 8px;
    }

    /* 모바일 최적화 */
    @media (max-width: 768px) {
      .drop-zone {
        touch-action: none;
      }
      
      .drop-zone:active {
        background-color: rgba(255, 165, 0, 0.7);
      }
    }
    
    /* 유닛 리스트 컨테이너 */
    .image-container {
      flex: 0.6;
      width: 360px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.1);
      padding: 5px;
      margin: 0px;
      -webkit-overflow-scrolling: touch;
    }
    
    .image-container h2 {
      text-align: center;
      margin-bottom: 5px;
      margin: 0px;
      font-size: 16px;
      color: #444;
    }
    
    .image-container h4 {
      font-size: 10px;
      font-weight: normal;
      color: #333;
      text-align: right;
      margin: 2px 0 5px 0;
    }
    
    .image-container img {
      width: 35px;
      height: 35px;
      margin: 3px;
      border: 1px solid #ddd;
      border-radius: 4px;
      object-fit: cover;
      cursor: grab;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    
    .image-container img:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    /* 하단 컨트롤 버튼 영역 */
    .controls {
      width: 360px;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: absolute;
      bottom: 70px;
      left: 10px;
      padding: 5px 0;
      background-color: #fff;
      border-top: 1px solid #ddd;
    }
    
    .controls .input-container {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    
    .controls .input-container label {
      font-size: 12px;
      color: #333;
      font-weight: bold;
    }
    
    .controls .input-container input {
      padding: 4px 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 60px;
      text-align: center;
      transition: all 0.3s;
    }
    
    .controls .input-container input:focus {
      border-color: #4caf50;
      outline: none;
      box-shadow: 0 0 4px rgba(76, 175, 80, 0.5);
    }
    
    .controls button {
      padding: 6px 10px;
      border: none;
      font-size: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    #reset-button {
      background-color: #ff6f61;
      color: white;
    }
    
    #reset-button:hover {
      background-color: #ff4d42;
    }
    
    #save-button {
      background-color: #4caf50;
      color: white;
    }
    
    #save-button:hover {
      background-color: #45a049;
    }
    .page-title {
      text-align: center;
      font-size: 17px;
      color: #333;
      background-color: #f1f1f1;
      border-bottom: 2px solid #ccc;
      position: relative;
    }
    
    .title-text {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      color: #181717;
      font-size: 12px;
      font-weight: normal;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="fixed-container">
    <!-- 상단 네비게이션 버튼 -->
    <div class="nav-container">
      <button class="round-btn" id="btn1" onclick="navigate('roundsindex.html')">
        <img src="https://github.com/SaeDing/NoInvadePls/blob/main/img/a.PNG?raw=true" alt="A">
        <span>고기</span>
      </button>
      <button class="round-btn" id="btn2" onclick="navigate('길드대전.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/1.png?raw=true" alt="B">
        <span>길드</span>
      </button>
      <button class="round-btn" id="btn3" onclick="navigate('월드보스1.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/1m.png?raw=true" alt="C">
        <span>보스1</span>
      </button>
      <button class="round-btn" id="btn4" onclick="navigate('월드보스2.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/4m.png?raw=true" alt="E">
        <span>보스2</span>
      </button>
      <button class="round-btn" id="btn4" onclick="navigate('월드보스3.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/5m.png?raw=true" alt="F">
        <span>보스3</span>
      </button>
      <button class="round-btn" id="btn4" onclick="navigate('일반.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/2m.png?raw=true" alt="G">
        <span>일반</span>
      </button>
      <button class="round-btn" id="btn4" onclick="navigate('어려움.html')">
        <img src="https://github.com/SaeDing/ABCD123123AAA/blob/main/img/3m.png?raw=true" alt="H">
        <span>어려움</span>
      </button>
    </div>
    <!-- 상단 타이틀 및 내부 컨테이너 -->
    <div class="container">
      <main>
        <div class="container">
          <div class="map-container" id="map-container">
            <img id="mapImage" src="./img/1.png" alt="Map Background">
            <div id="wave-gold-display"></div>
            <!-- 드롭존들 -->
            <div class="drop-zone" style="top:55px; left:75px;"></div>
            <div class="drop-zone" style="top:105px; left:75px;"></div>
            <div class="drop-zone" style="top:155px; left:75px;"></div>
            <div class="drop-zone" style="top:205px; left:75px;"></div>
            <div class="drop-zone" style="top:260px; left:75px;"></div>
            <div class="drop-zone" style="top:310px; left:75px;"></div>
            <!-- 두 번째 열 -->
            <div class="drop-zone" style="top:55px; left:120px;"></div>
            <div class="drop-zone" style="top:105px; left:120px;"></div>
            <div class="drop-zone" style="top:155px; left:120px;"></div>
            <div class="drop-zone" style="top:205px; left:120px;"></div>
            <div class="drop-zone" style="top:260px; left:120px;"></div>
            <div class="drop-zone" style="top:310px; left:120px;"></div>
            <!-- 세 번째 열 -->
            <div class="drop-zone" style="top:55px; left:206px;"></div>
            <div class="drop-zone" style="top:105px; left:206px;"></div>
            <div class="drop-zone" style="top:155px; left:206px;"></div>
            <div class="drop-zone" style="top:210px; left:206px;"></div>
            <div class="drop-zone" style="top:260px; left:206px;"></div>
            <div class="drop-zone" style="top:310px; left:206px;"></div>
            <!-- 네 번째 열 -->
            <div class="drop-zone" style="top:55px; left:255px;"></div>
            <div class="drop-zone" style="top:105px; left:255px;"></div>
            <div class="drop-zone" style="top:155px; left:255px;"></div>
            <div class="drop-zone" style="top:210px; left:255px;"></div>
            <div class="drop-zone" style="top:260px; left:255px;"></div>
            <div class="drop-zone" style="top:310px; left:255px;"></div>
          </div>
          <!-- 유닛 리스트 -->
          <div class="image-container" id="image-container">
            <h2>유닛 리스트</h2>
          </div>
        </div>
      </main>
      <!-- 하단 컨트롤 버튼 영역 -->
      <div class="controls">
        <div class="input-container">
          <label for="wave">WAVE:</label>
          <input type="number" id="wave" placeholder="값 입력" />
          <label for="gold">Gold:</label>
          <input type="number" id="gold" placeholder="값 입력" />
        </div>
        <button id="reset-button">초기화</button>
        <button id="save-button">PNG로 저장</button>
      </div>
    </div>
    <div class="title-text">길드 대전 배치표<br>[두 번 누르면 취소 가능]<br>(넣은 유닛 더블클릭으로 제거 가능)</div>
    <script>
      // img 폴더에 있는 파일명 리스트
      const imageFiles = [
        "우주인 3단 마딜.png",
        "보루 변신 물딜.png",
        "라이양 변신 마딜.png",
        "빅토리어스 마딜.png",
        "미믹 물딜.png",
        "눈보라 예티 변신 마딜.png",
        "슈퍼시바 마딜.png",
        "죽음의 기사 물딜.png",
        "스핑 물딜.png",
        "아마존 물딜.png",
        "마녀 마딜.png",
        "캔드리 물딜.png",
        "새싹이 물딜.png",
        "눈보라 예티 마딜.png",
        "라이양 마딜.png",
        "그린딩딩 물딜.png",
        "빅헤드 물딜.png",
        "역병의사 마딜.png",
        "해골룡 변신 마딜.png",
        "로큰롤스 마딜.png",
        "메카 좀비 마딜.png",
        "개굴 단장 변신 마딜.png",
        "선인장 건맨 물딜.png",
        "메카콩 마딜.png",
        "스시 선생 물딜.png",
        "카우보이 밥 물딜.png",
        "할로윈퀸 마딜.png",
        "오우거 전사 물딜.png",
        "돌팔이 마딜.png",
        "미라씨 물딜.png",
        "꼬꼬질라 물딜.png",
        "포크몬 물딜.png",
        "악마 토끼 마딜.png",
        "샤키 물딜.png",
        "스리슬쩍냥 물딜.png",
        "해골 궁수 물딜.png",
        "식빵 복서 물딜.png",
        "크레이지 핫도그 물딜.png",
        "오크라이더 물딜.png",
        "잭 오 마딜.png",
        "잭 오 변신 마딜.png",
        "전투 달팽이 물딜.png",
        "전투 달팽이 변신 물딜.png",
        "데드베어 마딜.png",
        "보루 물딜.png",
        "드라큐 마딜.png",
        "드라큐 변신 마딜.png",
        "크레이지 핫도그 변신 물딜.png",
        "프랑키 물딜.png",
        "해골룡 마딜.png",
        "개굴 단장 마딜.png",
        "우주인 1단 마딜.png",
        "우주인 2단 마딜.png"
      ];
      
      const imageContainer = document.getElementById("image-container");
      const dropZones = document.querySelectorAll(".drop-zone");
      const resetButton = document.getElementById("reset-button");
      const saveButton = document.getElementById("save-button");
      
      function navigate(page) {
        window.location.href = page;
      }
      
      let selectedImage = null;
      
      // 드래그 관련 변수
      let draggedElement = null;
      let sourceDropZone = null;
      let touchDragging = false;
      let touchTarget = null;
      let ghostImage = null;

      // 터치 시작 위치
      let startX = 0;
      let startY = 0;

      // 모든 드롭존 표시 함수
      function showAllDropZones() {
        dropZones.forEach(zone => {
          zone.style.visibility = "visible";
          zone.style.border = "1px dashed rgba(150, 150, 150, 0.8)";
          zone.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        });
      }

      // 빈 드롭존 숨기기 함수
      function hideEmptyDropZones() {
        dropZones.forEach(zone => {
          if (!zone.querySelector('img')) {
            zone.style.visibility = "hidden";
          } else {
            zone.style.border = "none";
            zone.style.backgroundColor = "rgba(0, 0, 0, 0)";
          }
        });
      }

      // 특정 위치에 있는 드롭존 찾기
      function findDropZoneAtPosition(x, y) {
        for (const zone of dropZones) {
          const rect = zone.getBoundingClientRect();
          if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
            return zone;
          }
        }
        return null;
      }

      // 현재 위치의 드롭존 하이라이트
      function highlightDropZoneAtPosition(x, y) {
        // 모든 드롭존의 기본 스타일 복원
        dropZones.forEach(zone => {
          zone.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        });
        
        // 현재 위치 아래의 드롭존 찾기 및 강조
        const zone = findDropZoneAtPosition(x, y);
        if (zone) {
          zone.style.backgroundColor = "rgba(255, 165, 0, 0.7)";
        }
      }

      // 드래그 중 시각적 피드백을 위한 고스트 이미지 생성
      function createGhostImage(img) {
        // 이미 고스트 이미지가 있으면 제거
        removeGhostImage();
        
        // 새 고스트 이미지 생성
        ghostImage = document.createElement('div');
        ghostImage.className = 'ghost-image';
        ghostImage.style.position = 'fixed';
        ghostImage.style.width = '40px';
        ghostImage.style.height = '40px';
        ghostImage.style.backgroundImage = `url(${img.src})`;
        ghostImage.style.backgroundSize = 'contain';
        ghostImage.style.backgroundRepeat = 'no-repeat';
        ghostImage.style.backgroundPosition = 'center';
        ghostImage.style.opacity = '0.7';
        ghostImage.style.pointerEvents = 'none';
        ghostImage.style.zIndex = '9999';
        
        // 초기 위치 설정
        ghostImage.style.left = startX + 'px';
        ghostImage.style.top = startY + 'px';
        
        // 페이지에 추가
        document.body.appendChild(ghostImage);
      }

      // 고스트 이미지 제거
      function removeGhostImage() {
        if (ghostImage && ghostImage.parentNode) {
          ghostImage.parentNode.removeChild(ghostImage);
          ghostImage = null;
        }
      }
      
      // 유닛 이미지에 드래그 속성 추가하는 함수
      function makeDraggable(img, zone) {
        img.draggable = true;
        
        // PC용 드래그 이벤트
        img.addEventListener('dragstart', function(e) {
          draggedElement = img;
          sourceDropZone = zone;
          
          // 모든 드롭존 표시
          showAllDropZones();
          
          // 드래그 중인 이미지 투명도 조정
          setTimeout(() => {
            img.style.opacity = '0.4';
          }, 0);
        });
        
        img.addEventListener('dragend', function() {
          img.style.opacity = '1';
          
          // 비어있는 드롭존 숨기기
          setTimeout(hideEmptyDropZones, 50);
          
          draggedElement = null;
          sourceDropZone = null;
        });
        
        // 모바일용 터치 이벤트
        img.addEventListener('touchstart', function(e) {
          // 기본 터치 동작 방지
          e.preventDefault();
          
          // 초기 터치 위치 저장
          const touch = e.touches[0];
          startX = touch.clientX;
          startY = touch.clientY;
          
          // 드래그 변수 설정
          touchTarget = img;
          sourceDropZone = zone;
          
          // 드래그 시작 상태로 설정
          setTimeout(() => {
            // 일정 시간 후에만 드래그 시작 (탭과 드래그 구분)
            touchDragging = true;
            
            // 드래그 중인 이미지 스타일 변경
            img.style.opacity = '0.4';
            
            // 고스트 이미지 생성 (선택사항)
            createGhostImage(img);
            
            // 모든 드롭존 표시
            showAllDropZones();
          }, 100);
        });
        
        img.addEventListener('touchmove', function(e) {
          if (!touchDragging) return;
          
          // 기본 스크롤 방지
          e.preventDefault();
          
          // 현재 터치 위치
          const touch = e.touches[0];
          const currentX = touch.clientX;
          const currentY = touch.clientY;
          
          // 고스트 이미지가 있으면 이동
          if (ghostImage) {
            ghostImage.style.left = (currentX - 20) + 'px';
            ghostImage.style.top = (currentY - 20) + 'px';
          }
          
          // 현재 터치 위치 아래에 있는 드롭존 찾기
          highlightDropZoneAtPosition(currentX, currentY);
        });
        
        img.addEventListener('touchend', function(e) {
          if (!touchDragging) return;
          
          // 터치 종료 위치
          const touch = e.changedTouches[0];
          const endX = touch.clientX;
          const endY = touch.clientY;
          
          // 드롭 대상 찾기
          const targetZone = findDropZoneAtPosition(endX, endY);
          
          // 고스트 이미지 제거
          removeGhostImage();
          
          // 유효한 드롭존을 찾았고, 원래 위치와 다른 경우
          if (targetZone && targetZone !== sourceDropZone) {
            // 이미 타겟 드롭존에 이미지가 있으면 제거
            if (targetZone.querySelector('img')) {
              targetZone.querySelector('img').remove();
            }
            
            // 이미지 이동
            sourceDropZone.removeChild(touchTarget);
            targetZone.appendChild(touchTarget);
            
            // 드래그 기능 다시 적용
            makeDraggable(touchTarget, targetZone);
            
            // localStorage 업데이트
            const sourceIndex = Array.from(dropZones).indexOf(sourceDropZone);
            const targetIndex = Array.from(dropZones).indexOf(targetZone);
            
            delete dropData[sourceIndex];
            dropData[targetIndex] = touchTarget.src;
            localStorage.setItem('dropData', JSON.stringify(dropData));
            
            // 스타일 복원
            targetZone.style.border = "none";
            targetZone.style.backgroundColor = "rgba(0, 0, 0, 0)";
          }
          
          // 상태 초기화
          touchTarget.style.opacity = '1';
          touchDragging = false;
          touchTarget = null;
          sourceDropZone = null;
          
          // 비어있는 드롭존 숨기기
          setTimeout(hideEmptyDropZones, 50);
        });
        
        // 터치 캔슬 처리
        img.addEventListener('touchcancel', function() {
          if (touchDragging) {
            // 상태 초기화
            touchTarget.style.opacity = '1';
            removeGhostImage();
            touchDragging = false;
            touchTarget = null;
            sourceDropZone = null;
            
            // 비어있는 드롭존 숨기기
            setTimeout(hideEmptyDropZones, 50);
          }
        });
      }
      
      // 드롭존 이미지 정보를 저장할 객체 (인덱스: 이미지 src)
      let dropData = {};
      const savedDropData = localStorage.getItem('dropData');
      if(savedDropData) {
        dropData = JSON.parse(savedDropData);
      }
      
      // 페이지 로딩 시 저장된 dropData를 불러와 드롭존에 이미지 배치 및 스타일 초기화
      dropZones.forEach((zone, index) => {
        if(dropData[index]) {
          const img = document.createElement("img");
          img.src = dropData[index];
          img.alt = "dropped-image";
          img.style.width = "125%";
          img.style.height = "125%";
          zone.appendChild(img);
          zone.style.visibility = "visible";
          // 이미지가 있으면 테두리와 배경을 숨김
          zone.style.border = "none";
          zone.style.backgroundColor = "rgba(0, 0, 0, 0)";
          
          // 드래그 가능하게 설정
          makeDraggable(img, zone);
        } else {
          zone.style.visibility = "hidden";
          zone.style.border = "1px dashed rgba(102, 102, 102, 0.6)";
          zone.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        }
      });
      
      // 유닛 클릭 시 선택 및 배경색 변경
      imageFiles.forEach(file => {
        const img = document.createElement("img");
        img.src = `img/${file}`;
        img.alt = file;
        img.draggable = false;
        img.addEventListener("click", () => {
          if (img.style.backgroundColor === "lightpink") {
            img.style.backgroundColor = "";
            selectedImage = null;
            dropZones.forEach(zone => {
              const zoneImage = zone.querySelector("img");
              zone.style.border = "none";
              zone.style.backgroundColor = "rgba(0, 0, 0, 0)";
              if (!zoneImage) {
                zone.style.visibility = "hidden";
              }
            });
            return;
          }
          document.querySelectorAll(".image-container img").forEach(image => {
            image.style.backgroundColor = "";
          });
          img.style.backgroundColor = "lightpink";
          selectedImage = img.src;
          dropZones.forEach(zone => {
            zone.style.visibility = "visible";
            zone.style.border = "1px dashed rgba(150, 150, 150, 0.8)";
            zone.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
          });
        });
        imageContainer.appendChild(img);
      });
      
      // 드롭존 이벤트: 클릭 시 이미지 추가, 더블클릭/터치 시 이미지 제거
      dropZones.forEach((zone, index) => {
        zone.addEventListener("click", () => {
          if (selectedImage) {
            if (zone.querySelector("img")) {
              zone.querySelector("img").remove();
            }
            const img = document.createElement("img");
            img.src = selectedImage;
            img.alt = "dropped-image";
            img.style.width = "142%";
            img.style.height = "142%";
            zone.appendChild(img);
            
            // 추가된 이미지에 드래그 기능 적용
            makeDraggable(img, zone);
            
            // 선택된 이미지 정보를 dropData에 저장 후 localStorage 업데이트
            dropData[index] = selectedImage;
            localStorage.setItem('dropData', JSON.stringify(dropData));
            document.querySelectorAll(".image-container img").forEach(image => {
              image.style.backgroundColor = "";
            });
            selectedImage = null;
            dropZones.forEach(zone => {
              zone.style.border = "none";
              zone.style.backgroundColor = "rgba(0, 0, 0, 0)";
            });
          }
        });
        
        // 데스크톱: 더블클릭 시 이미지 제거 및 캐시 업데이트
        zone.addEventListener("dblclick", () => {
          const img = zone.querySelector("img");
          if (img) {
            img.remove();
            delete dropData[index];
            localStorage.setItem('dropData', JSON.stringify(dropData));
            // 이미지가 제거된 후 드롭존 스타일 업데이트
            zone.style.visibility = "hidden";
          }
        });
        
        // 모바일: 터치 후 더블탭 감지
        zone.addEventListener("touchend", function(e) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - (zone.lastTap || 0);
          if (tapLength > 0 && tapLength < 300) {
            const img = zone.querySelector("img");
            if (img) {
              img.remove();
              delete dropData[index];
              localStorage.setItem('dropData', JSON.stringify(dropData));
              // 이미지가 제거된 후 드롭존 스타일 업데이트
              zone.style.visibility = "hidden";
            }
            zone.lastTap = 0;
            e.preventDefault();
            return false;
          } else {
            zone.lastTap = currentTime;
          }
        });
        
        // 드롭존에 드래그오버 이벤트 추가
        zone.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          zone.style.backgroundColor = 'rgba(255, 165, 0, 0.5)';
        });
        
        // 드롭존에서 드래그 벗어날 때
        zone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          e.stopPropagation();
          zone.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
        });
        
        // 드롭존에 드롭 이벤트 추가
        zone.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          zone.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          
          // 드래그된 이미지가 있고, 다른 드롭존인 경우
          if (draggedElement && sourceDropZone && sourceDropZone !== zone) {
            // 이미 이미지가 있으면 제거
            if (zone.querySelector('img')) {
              zone.querySelector('img').remove();
            }
            
            // 이미지 이동
            sourceDropZone.removeChild(draggedElement);
            zone.appendChild(draggedElement);
            
            // 드래그 기능 재설정
            makeDraggable(draggedElement, zone);
            
            // localStorage 업데이트
            const sourceIndex = Array.from(dropZones).indexOf(sourceDropZone);
            const targetIndex = Array.from(dropZones).indexOf(zone);
            
            delete dropData[sourceIndex];
            dropData[targetIndex] = draggedElement.src;
            localStorage.setItem('dropData', JSON.stringify(dropData));
            
            // 드롭존 스타일 설정
            zone.style.border = "none";
            zone.style.backgroundColor = "rgba(0, 0, 0, 0)";
          }
        });
      });
      
      resetButton.addEventListener("click", () => {
        dropZones.forEach(zone => {
          zone.innerHTML = ""; // 드롭존 비우기
          zone.style.visibility = "hidden";
          zone.style.border = "1px dashed rgba(102, 102, 102, 0.6)";
          zone.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        });
        // 캐시 데이터 초기화
        dropData = {};
        localStorage.removeItem('dropData');
        
        // 선택 상태 초기화
        document.querySelectorAll(".image-container img").forEach(image => {
          image.style.backgroundColor = "";
        });
        selectedImage = null;
        
        // wave와 gold 입력값 초기화
        const waveInput = document.getElementById("wave");
        const goldInput = document.getElementById("gold");
        waveInput.value = "";
        goldInput.value = "";
        
        // wave와 gold 값 초기화
        const waveGoldDisplay = document.getElementById("wave-gold-display");
        waveGoldDisplay.textContent = "";
      });
      
      saveButton.addEventListener("click", () => {
        const waveInput = document.getElementById("wave");
        const goldInput = document.getElementById("gold");
        const waveValue = waveInput.value.trim();
        const goldValue = goldInput.value.trim();
    
        // WAVE & GOLD 텍스트 설정
        let displayText = "";
        if (waveValue) {
          displayText += `WAVE: ${waveValue}`;
        }
        if (goldValue) {
          if (displayText) displayText += " | ";
          displayText += `Gold: ${goldValue}`;
        }
    
        // 텍스트 표시 영역 업데이트
        const waveGoldDisplay = document.getElementById("wave-gold-display");
        waveGoldDisplay.textContent = displayText;
        waveGoldDisplay.style.color = "white";
        waveGoldDisplay.style.position = "absolute";
        waveGoldDisplay.style.top = "9px";
        waveGoldDisplay.style.right = "0px";
        waveGoldDisplay.style.fontSize = "9px";
        waveGoldDisplay.style.fontWeight = "bold";
        waveGoldDisplay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
        waveGoldDisplay.style.padding = "5px 10px";
        waveGoldDisplay.style.borderRadius = "5px";
        
        // 캡처 중에는 드롭존 테두리를 숨김
        dropZones.forEach(zone => {
          if (zone.querySelector('img')) {
            zone.style.border = "none";
          } else {
            zone.style.visibility = "hidden";
          }
        });
    
        // 100ms 대기 후 캡처 실행 (텍스트 업데이트 반영)
        setTimeout(() => {
          const mapImageElement = document.getElementById("mapImage");
          const imageHeight = mapImageElement.clientHeight;
          html2canvas(document.getElementById("map-container"), {
            scrollX: 0,
            scrollY: 0,
            height: imageHeight,
            windowWidth: document.documentElement.offsetWidth,
            windowHeight: document.documentElement.offsetHeight,
            scale: 10,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null
          }).then((canvas) => {
            const link = document.createElement("a");
            link.download = "map.png";
            link.href = canvas.toDataURL("image/png", 1.0);
            link.click();
    
            // 캡처 후 텍스트 초기화
            waveGoldDisplay.textContent = "";
          });
        }, 100);
      });
      
      // 드롭존과 관련된 요소 선택
      const mapContainer = document.getElementById("map-container");
      const mapImage = document.getElementById("mapImage");
    
      // mapImage의 실제 표시 영역 계산 후 드롭존 위치 보정
      mapImage.onload = () => {
        const imageRect = mapImage.getBoundingClientRect();
        const containerRect = mapContainer.getBoundingClientRect();
        const offsetX = imageRect.left - containerRect.left;
        const offsetY = imageRect.top - containerRect.top;
    
        dropZones.forEach(zone => {
          const origTop = parseInt(zone.style.top, 10);
          const origLeft = parseInt(zone.style.left, 10);
          zone.style.top = (origTop + offsetY) + "px";
          zone.style.left = (origLeft + offsetX) + "px";
        });
      };
      
      // 유닛 리스트의 이미지는 여전히 드래그 불가능하게 유지
      document.querySelectorAll('.image-container img').forEach(img => {
        img.addEventListener('dragstart', function(e) {
          e.preventDefault(); // 유닛 리스트의 이미지는 여전히 드래그 방지
        });
      });
      
      // 전체 문서에 드래그 이벤트 추가
      document.addEventListener('dragover', function(e) {
        // 드래그 중일 때 드롭존이 모두 보이도록 유지
        if (draggedElement) {
          dropZones.forEach(zone => {
            if (zone.style.visibility !== "visible") {
              zone.style.visibility = "visible";
            }
          });
        }
      });
    </script>
  </div>
</body>
</html>