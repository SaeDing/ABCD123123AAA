<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Atlas & PNG ë¶„í•  ë„êµ¬ (íšŒì „ ë° offsets í¬í•¨)</title>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      scroll-behavior: smooth;
    }
    nav {
      background-color: #333;
      padding: 10px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      text-align: center;
    }
    nav a {
      color: #fff;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .container {
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 800px;
      margin: 80px auto 20px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="file"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #5cb85c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #4cae4c;
    }
    .result-container {
      margin-top: 30px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    .result-section ul {
      list-style-type: none;
      padding: 0;
    }
    .result-section li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .result-section li:last-child {
      border-bottom: none;
    }
    .thumbnail {
      width: 80px;
      height: auto;
      margin-right: 10px;
      border: 1px solid #ddd;
      padding: 2px;
      background-color: #fff;
    }
  </style>
  <!-- JSZipì™€ FileSaver ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <nav>
    <a href="#">Atlas ë¶„í•  ë„êµ¬</a>
  </nav>
  <div class="container">
    <h1>Atlas & PNG íŒŒì¼ ì„ íƒ</h1>
    <div class="form-group">
      <label for="atlasFile">Atlas íŒŒì¼ ì„ íƒ (.txt ë˜ëŠ” .atlas)</label>
      <input type="file" id="atlasFile" accept=".txt,.atlas,.bytes">
    </div>
    <div class="form-group">
      <label for="pngFile">PNG íŒŒì¼ ì„ íƒ</label>
      <input type="file" id="pngFile" accept=".png">
    </div>
    <button id="processButton">ë¶„í•  ì‹¤í–‰</button>
    <div id="result" class="result-container"></div>
  </div>

  <script>
    // ë²”ìš© íšŒì „ í•¨ìˆ˜: ìº”ë²„ìŠ¤ë¥¼ ì£¼ì–´ì§„ ê°ë„(degree)ë§Œí¼ íšŒì „
    function rotateCanvas(canvas, angle) {
      const rad = angle * Math.PI / 180;
      const sin = Math.abs(Math.sin(rad));
      const cos = Math.abs(Math.cos(rad));
      const width = canvas.width;
      const height = canvas.height;
      const newWidth = Math.ceil(width * cos + height * sin);
      const newHeight = Math.ceil(width * sin + height * cos);
      let rotated = document.createElement('canvas');
      rotated.width = newWidth;
      rotated.height = newHeight;
      let rctx = rotated.getContext('2d');
      rctx.save();
      rctx.translate(newWidth / 2, newHeight / 2);
      rctx.rotate(rad);
      rctx.drawImage(canvas, -width / 2, -height / 2);
      rctx.restore();
      return rotated;
    }

    // Atlas íŒŒì¼ íŒŒì„œ: ê° ì˜ì—­(region)ì˜ ì´ë¦„, bounds, rotate, offsets ì •ë³´ë¥¼ íŒŒì‹±
    function parseAtlas(text) {
        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const regions = [];
        let i = 0;

        // ì²« ì¤„ì´ PNG íŒŒì¼ëª…ì¼ ê²½ìš° ê±´ë„ˆë›°ê¸°
        if (lines[0].toLowerCase().endsWith('.png')) {
            i = 1;
        }

        // í—¤ë” ë¶€ë¶„(ì†ì„±ì´ í¬í•¨ëœ ì¤„) ê±´ë„ˆë›°ê¸°
        while (i < lines.length && lines[i].includes(':')) {
            i++;
        }

        // ê° ì˜ì—­(region) íŒŒì‹±
        while (i < lines.length) {
            const regionName = lines[i];
            i++;
            let bounds = null, offsets = null, rotate = 0;

            while (i < lines.length && lines[i].includes(':')) {
                const [key, value] = lines[i].split(":").map(s => s.trim());
                const lowerKey = key.toLowerCase();

                if (lowerKey === 'bounds') {
                    const nums = value.split(',').map(s => parseInt(s.trim()));
                    if (nums.length >= 4) {
                        bounds = { x: nums[0], y: nums[1], width: nums[2], height: nums[3] };
                    }
                } else if (lowerKey === 'rotate') {
                    rotate = parseFloat(value);
                } else if (lowerKey === 'offsets') {
                    const nums = value.split(',').map(s => parseInt(s.trim()));
                    if (nums.length >= 4) {
                        offsets = { x: nums[0], y: nums[1], width: nums[2], height: nums[3] };
                    }
                }
                i++;
            }

            if (bounds) {
                console.log(`Region: ${regionName}, bounds: ${JSON.stringify(bounds)}, offsets: ${JSON.stringify(offsets)}, rotate: ${rotate}`);
                regions.push({ name: regionName, bounds: bounds, offsets: offsets, rotate: rotate });
            }
        }
        return regions;
    }

    // ì˜ì—­ ìë¥´ê¸° í•¨ìˆ˜: rotateê°€ 90 ë˜ëŠ” -90ì´ë©´ widthì™€ heightë¥¼ êµí™˜í•´ì„œ ì¶”ì¶œ
    function cropRegion(image, region) {
        let { x, y, width, height } = region.bounds;
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');

        // ğŸ”¥ rotate:90ì¸ ê²½ìš° width â†” height êµí™˜í•˜ì—¬ ì˜¬ë°”ë¥´ê²Œ ìë¥´ê¸°
        if (region.rotate === 90) {
            let temp = width;
            width = height;
            height = temp;
        }

        console.log(`âœ‚ï¸ Cropping: ${region.name} â†’ x=${x}, y=${y}, width=${width}, height=${height}`);

        // ğŸŒŸ ì˜¬ë°”ë¥´ê²Œ í¬ë¡­í•˜ê¸° (rotate ì‹ ê²½ ì•ˆ ì”€)
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(image, x, y, width, height, 0, 0, width, height);

        return canvas;
    }

    // ì¶”ì¶œëœ ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë°°ì—´
    const extractedImages = [];

    document.getElementById('processButton').addEventListener('click', function() {
        const atlasFileInput = document.getElementById('atlasFile');
        const pngFileInput = document.getElementById('pngFile');
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”
        extractedImages.length = 0;

        if (atlasFileInput.files.length === 0 || pngFileInput.files.length === 0) {
            alert("Atlas íŒŒì¼ê³¼ PNG íŒŒì¼ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.");
            return;
        }

        const atlasFile = atlasFileInput.files[0];
        const pngFile = pngFileInput.files[0];

        const readerAtlas = new FileReader();
        const readerPNG = new FileReader();

        // ğŸ”¥ `.bytes` íŒŒì¼ í™•ì¥ìë„ í—ˆìš©
        let atlasFileName = atlasFile.name;
        if (atlasFileName.endsWith(".bytes")) {
            atlasFileName = atlasFileName.replace(".bytes", ".txt");
        }

        readerAtlas.onload = function(e) {
            const atlasText = e.target.result;
            const regions = parseAtlas(atlasText);

            readerPNG.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const ul = document.createElement('ul');
                    regions.forEach(region => {
                        const canvas = cropRegion(img, region);
                        const dataURL = canvas.toDataURL("image/png");
                        extractedImages.push({ name: region.name + ".png", dataURL: dataURL });
                        const li = document.createElement('li');
                        const thumbnail = document.createElement('img');
                        thumbnail.src = dataURL;
                        thumbnail.className = "thumbnail";
                        const link = document.createElement('a');
                        link.href = dataURL;
                        link.download = region.name + ".png";
                        link.textContent = region.name + ".png";
                        li.appendChild(thumbnail);
                        li.appendChild(link);
                        ul.appendChild(li);
                    });
                    resultDiv.appendChild(ul);
                    // ZIP ì €ì¥ ë²„íŠ¼ ìƒì„±
                    const zipButton = document.createElement('button');
                    zipButton.textContent = "ZIPë¡œ ì €ì¥";
                    zipButton.addEventListener('click', createAndDownloadZip);
                    resultDiv.appendChild(zipButton);
                }
                img.src = event.target.result;
            }
            readerPNG.readAsDataURL(pngFile);
        }

        // ğŸ”¥ `.bytes` íŒŒì¼ë„ `.txt`ì²˜ëŸ¼ ì²˜ë¦¬í•´ì„œ ì½ê¸°
        readerAtlas.readAsText(atlasFile);
    });

    document.getElementById('atlasFile').addEventListener('change', function(event) {
    const file = event.target.files[0];

    // ğŸ”¥ `*.atlas.bytes` íŒŒì¼ë§Œ í—ˆìš©
    if (file && !file.name.endsWith(".atlas.bytes")) {
        alert("âŒ ì˜¤ë¥˜: '*.atlas.bytes' í™•ì¥ìë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
        event.target.value = ""; // ì„ íƒí•œ íŒŒì¼ ì´ˆê¸°í™”
    }
});


    function createAndDownloadZip() {
        const zip = new JSZip();
        extractedImages.forEach(file => {
            const base64Data = file.dataURL.split(',')[1];
            zip.file(file.name, base64Data, {base64: true});
        });
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "extracted_images.zip");
        });
    }
</script>

</body>
</html>
